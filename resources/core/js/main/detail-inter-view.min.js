var interview = {
    status: {
        ChuaDienRa: 0,
        DangDienRa: 1,
        DaKetThuc: 2
    },
    order: {
        desc: 1,
        asc: 2
    },
    flag: false,
    timeCountDown: null,
    timeout: null,
    time: 20000,
    divWrap: '#interview-content-place',
    iframe: {
        src: null,
        width: 600,
        height: 400,
        padding: 30
    },
    channelHeight: 380,
    firstLoad: true,
    init: function () {
        var me = this;

        $('#btnSendInterView:not(.sending)').on('click', function () {
            me.insertInterView();
        });

        //me.hideSidebar();
        me.bindData();

        $(".interview-content .detail-viewmore").on('click', function () {
            $('body,html').animate({
                scrollTop: $(".interview-content").offset().top
            }, 1000);
        });
    },
    insertInterView: function () {
        var me = this;
        var name = $('#txtNameInterView').val();
        var email = $('#txtEmailInterView').val();
        var content = $('#txtContentInterView').val();
        var newsid = $('#hdInterviewId').val();
        // var captcha = $('#txtcapcha').val();
        var ns = pageSettings.DOMAIN_API_NAME_SPACE;

        if (typeof newsid == 'undefined' || newsid == '') {
            return false;
        }
        if (typeof name == 'undefined' || name == '') {
            customAlert.alert('Bạn chưa nhập họ tên!');
            return false;
        }
        if (typeof email == 'undefined' || email == '') {
            customAlert.alert('Bạn chưa nhập email!')
            return false;
        }
        if (!validateEmail(email)) {
            customAlert.alert('Email sai định dạng!')
            return false;
        }
        if (typeof content == 'undefined' || content == '') {
            customAlert.alert('Bạn chưa nhập nội dung!')
            return false;
        }
        // if (typeof captcha == 'undefined' || captcha == '') {
        //     alert('Bạn chưa nhập mã captcha!')
        //     return false;
        // }
        var data = {
            fullname: name,
            email: email,
            content: content,
            id: newsid,
            // captcha: captcha,
            ns:ns,
            type:'interview_insert'

        }
        $.ajax({
            type: "POST",
            // url: pageSettings.DomainUtils2 + '/api-insertinterview',
            url: pageSettings.DomainUtils2 + "/api/microsite-api.htm",
            data: data,timeout: 5000,
            xhrFields: {
                withCredentials: true
            },
            beforeSend: function () {
                $('#btnSendInterView').addClass('sending');
            },
            success: function (rs) {
                $('#btnSendInterView').removeClass('sending');
                if (rs.success) {
                    customAlert.alert('Câu hỏi của bạn đã được gửi!');
                    $('#txtNameInterView').val('');
                    $('#txtEmailInterView').val('');
                    $('#txtContentInterView').val('');
                    $('.modal').removeClass('show');
                    $('.detail--interView').removeClass('open-modal');
                    // $('#imgcaptchaapi').attr('src', pageSettings.DomainUtils2 + '/get-captcha.htm?v=' + new Date().getTime());
                    // $('#txtcapcha').val('');
                } else {
                    if (rs.message == '')
                        customAlert.alert('Câu hỏi của bạn chưa gửi được, vui lòng thử lại sau!')
                    else
                        customAlert.alert(rs.message)
                }
            },
            error: function () {
                $('#btnSendInterView').removeClass('sending');
            }
        });
    },
    countDown: function () {
        var me = this;
        clearInterval(me.timeCountDown);
        var count = (me.time / 1000) - 1;
        if ($('.itvCountDown').length == 0) {
            $('.clickpopupdetail').after(String.format('<p class="itvCountDown" style="margin-top:20px;width:100%;float:left;text-align:center;font-size:15px;height:40px;font-weight:bold; display: block;">Tự động cập nhật trong <span>{0}</span> giây...</p>', count));
        } else {
            $('.itvCountDown').html(String.format('Tự động cập nhật trong <span>{0}</span> giây...', count));
        }
        me.timeCountDown = setInterval(function () {
            count--;
            if (count <= 0) {
                clearInterval(me.timeCountDown);
                $(".itvCountDown").html('<div class="layout__loading" style="visibility: visible;"><div class="formLoader"><ul class="formLoading"><li></li><li></li><li></li></ul><p class="text">Loading...</p></div></div>');
            } else {
                $('.itvCountDown span').text(count);
            }
        }, 1000);
    },
    bindData: function () {
        var me = this;
        var ns = pageSettings.DOMAIN_API_NAME_SPACE;
        if (me.flag) return;
        me.flag = true;
        var interviewId = $('#hdInterviewId').val();
        if (typeof interviewId == 'undefined' || interviewId == '0')
            return false;

        $.ajax({
            type: 'GET',
            url: pageSettings.DomainUtils2 + '/api/microsite-api.htm',
            data: { id: interviewId, action: 1,ns:ns,type:'interview' },
            dataType: "json",timeout: 5000,
            success: function (msg) {
                console.log(msg)
                if (msg.success) {
                    if (msg.data != null) {
                        if (msg.data.questions != null && msg.data.questions.length > 0) {
                            var data = me.genHtml(msg.data.questions);

                            if ($(me.divWrap).children().length > 0) {
                                me.appendData(msg.data.questions, $('.reverse option:selected').val());
                            } else {
                                $(data).appendTo(me.divWrap).hide().fadeIn(600);
                                me.timeout = setInterval("interview.bindData();", me.time);
                            }
                        } else {
                            clearInterval(me.timeout);
                            me.timeout = setInterval("interview.bindData();", me.time);
                        }
                    } else {
                        clearInterval(me.timeout);
                        me.timeout = setInterval("interview.bindData();", me.time);
                    }

                    if (msg.Status == me.status.DaKetThuc) {
                        me.flag = true;
                        clearInterval(me.timeout);
                        $('.interview-content .clickpopupdetail, #fromGuiTin').remove();
                    } else if (msg.Status == me.status.ChuaDienRa) {
                        $('#interview-content-place').prepend('<p class="itvListTitle">Danh sách câu hỏi&nbsp;&nbsp;(' + $('.interview-item').length + ')</p>');
                        $('.interview-answer').remove();

                        me.flag = true;
                        clearInterval(me.timeout);
                    } else {//dang dien ra
                        if (me.firstLoad) {
                            //$('.detail-content').hide();
                            me.firstLoad = false;
                        }
                        me.flag = false;
                        me.countDown();
                    }

                    //call videoplayer mới
                    if ($('#interview-content-place').length > 0) {
                        videoHD.isAd = true;
                        videoHD.init("#interview-content-place", {
                            type: videoHD.videoType.newsDetail
                        });
                        videoInContent.init('#interview-content-place');
                    }
                }
            }
        });
    },
    buildQA: function (q, iscontent) {
        var me = this;

        var htmlTemp = '<div class="detail-quser inter-flex">\
                                         <span class="avatar_u"> <img src="https://static.mediacdn.vn/images/ava_inter.png" alt="avatar"> </span>\
                                       <div class="quser-content">\
                                            <span class="user-name">{0}</span>\
                                            <span class="add">{6}</span>\
                                        </div>\
                                    </div>\
                                    <div class="detail-q">{2}</div>\
                                    {3}';

        var htmlAswer = '<div class="detail-a interview-answer " data-guestsid="{2}" id="as-{3}" dt="{4}">\
                                        <div class="detail-auser">\
                                            <div class="auser-content">\
                                                <span class="user-name">{0}</span>\
                                            </div>\
                                            <div class="avt avatar_u">{5}</div>\
                                        </div>\
                                        <p class="a-content">{1}</p>\
                                    </div>';
        var html = ''
        var htmlAs = '';
        if (q.answers != null && q.answers.length > 0) {
            for (var i = 0; i < q.answers.length; i++) {
                var dr = q.answers[i];
                avatar='';
                if ( dr.avatar != null && dr.avatar != ""){
                    avatar = img_thumb(dr.avatar);
                }

                htmlAs += String.format(htmlAswer, dr.fullName, dr.answers_content, dr.guests_id, dr.id, new Date(dr.modified_date).getTime(),(avatar)?avatar:"<img src='https://static.mediacdn.vn/images/ava_inter.png' alt='avatar'>",(q.address)?q.address:'');
            }
        }

        html = (iscontent) ?
            String.format(htmlTemp, q.fullname, formatDateHHmmDDMMYYY(q.received_date), q.content, htmlAs,'','',(q.address)?q.address:'') :
            String.format('<div class="detail-question interview-item qna" id="interview-item-{0}" dt="{1}">', q.id, new Date(q.received_date).getTime()) + String.format(htmlTemp, q.fullname, formatDateHHmmDDMMYYY(q.received_date), q.content, htmlAs, q.id, new Date(q.received_date).getTime(),(q.address)?q.address:'') + '</div>';

        return html;
    },
    genHtml: function (data) {
        var me = this;
        var html = data;
        if (data != null && data.length > 0) {
            html = [];
            for (var i = 0; i < data.length; i++) {
                html.push(me.buildQA(data[i]));
            }
        }
        return $(html.join(''));
    },
    appendData: function (data, order) {
        var htmlAswer = '<div class="detail-a interview-answer" data-guestsid="{2}" id="as-{3}" dt="{4}">\
                                        <p class="user-name">{0}</p>\
                                        <p class="a-content">{1}</p>\
                                    </div>';
        var me = this;
        var arrListId = [];
        for (var i = 0; i < data.length; i++) {
            var id = data[i].id;
            var result = '';


            if ($('#interview-item-' + id).length == 0) {//chua co tin
                result = me.buildQA(data[i]);
                $(me.divWrap).prepend(result);
            } else {//kiem tra xem co update ko câu hỏi
                result = me.buildQA(data[i], true);
                var itvDate = $('#interview-item-' + id).attr('dt');
                var dateStamp = new Date(data[i].modified_date).getTime() + '';
                if (itvDate != dateStamp) {
                    $('#interview-item-' + id).html(result);
                }
                if (data[i].answers != null && data[i].answers.length > 0) {
                    for (var j = 0; j < data[i].answers.length; j++) {
                        var dr = data[i].answers[j];
                        var idAs = dr.id;
                        var itvDateAs = $('#as-' + idAs).attr('dt');
                        var dateStampAs = new Date(data[i].answers[j].modified_date).getTime() + '';

                        if ( dr.avatar != null && dr.avatar != ""){
                            avatar = img_thumb(dr.avatar);
                        }
                        if (itvDateAs != dateStampAs) {
                            console.log('trường',dr)
                            var itemAs = String.format(htmlAswer, dr.fullName, dr.answers_content, dr.guests_id, dr.id, new Date(dr.modified_date).getTime(),avatar);
                            $('#as-' + idAs).html(itemAs);
                        }
                    }
                }
            }

            arrListId.push(id);
        }
    },
    formatDate: function (date) {
        var d;
        try {
            d = new Date(date.replace('T', ' '));
        } catch (e) {
            d = new Date();
        }

        return ("00" + d.getHours()).slice(-2) + ":" +
            ("00" + d.getMinutes()).slice(-2) + " ngày " +
            ("00" + d.getDate()).slice(-2) + "/" +
            ("00" + (d.getMonth() + 1)).slice(-2) + "/" +
            d.getFullYear();
    },
    shareLink: function (id) {
        //return String.format("https://cafef.vn/interview-{0}.chn", id);
    }
};

function img_thumb(img, imgw) {
    if (typeof imgw == "undefined")
        imgw = 80;
    if (img == null || img == '')
        return '';
    if (img.startsWith('http'))
        return `<img class="avatar" src="${img}" />`;

    return '<img class="avatar" src="' + pageSettings.imageDomain+"/zoom/" + imgw +'_' + imgw + "/" + img + '" />';
}
function formatDateHHmmDDMMYYY(n, t) {
    typeof t == "undefined" && (t = "/");
    try {
        var n = new Date(n.replace(" ", "T")),
            i = n.getHours(),
            r = n.getMinutes(),
            u = n.getDate(),
            f = n.getMonth() + 1,
            e = n.getFullYear();
        return i + ":" + r + " " + u + t + f + t + e
    } catch (o) {
        return n
    }
}

$('[data-act="open-modal"]').click(function(n) {
    n.preventDefault();
    let t = $(this).attr("data-modal");
    $(".modal[data-id=" + t + "]").addClass("show");
    $(".detail--interView").addClass("open-modal")
});
$(".modal-bg").click(function(n) {
    n.preventDefault();
    $(".modal").removeClass("show");
    $(".detail--interView").removeClass("open-modal")
});

$(function () {

    $(document).click(function (e) {
        if ($(e.target).attr("class") == 'overlay') {
            toggleXemthem();
        }
    });
    if ($('.refresh-captcha').length > 0) {
        $('.refresh-captcha').on('click', function () {
            $('#imgcaptchaapi').attr('src', pageSettings.DomainUtils2 + '/api/get-captcha.htm?v=' + new Date().getTime());
        });
    }
});

$(".modal-header .close").click(function(n) {
    n.preventDefault();
    $(".modal").removeClass("show");
    $(".detail--interView").removeClass("open-modal");

});
function validateEmail(n) {
    return /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(n).toLowerCase())
}
